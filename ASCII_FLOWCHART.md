# KG-RAG 问答系统 ASCII 流程图

## 🎯 主流程图

```
                    ┌─────────────────────────┐
                    │    用户输入问题         │
                    │ "Who leads Belgium?"    │
                    └──────────┬──────────────┘
                               │
                               ▼
                    ┌─────────────────────────┐
                    │    问题向量化           │
                    │   BAAI/bge-m3          │
                    │ [0.1, 0.3, -0.2, ...]  │
                    └──────────┬──────────────┘
                               │
                               ▼
                    ┌─────────────────────────┐
                    │   向量数据库检索        │
                    │     ChromaDB           │
                    │    Top-5 相似文档       │
                    └──────────┬──────────────┘
                               │
                               ▼
                    ┌─────────────────────────┐
                    │   获取检索结果          │
                    │ 1.(Belgium,capital,     │
                    │    Brussels)            │
                    │ 2.(Iraq,leader,         │
                    │    Haider_al-Abadi)     │
                    └──────────┬──────────────┘
                               │
                               ▼
                    ┌─────────────────────────┐
                    │   问题类型检测          │
                    │   结果: Subject         │
                    └──────────┬──────────────┘
                               │
                               ▼
        ┌──────────────────────────────────────────────────────────┐
        │                CoTKR 重写策略选择                         │
        └─┬─────────┬─────────────┬─────────────┬─────────────────┬─┘
          │         │             │             │                 │
          ▼         ▼             ▼             ▼                 ▼
    ┌─────────┐┌─────────┐┌─────────────┐┌─────────────┐┌─────────────┐
    │Subject  ││Object   ││ Relation    ││    Type     ││   其他类型   │
    │ 重写    ││ 重写    ││   重写      ││   重写      ││             │
    │策略     ││策略     ││   策略      ││   策略      ││             │
    └────┬────┘└────┬────┘└──────┬──────┘└──────┬──────┘└──────┬──────┘
         │          │             │              │              │
         └──────────┼─────────────┼──────────────┼──────────────┘
                    │             │              │
                    └─────────────┼──────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │   CoTKR 思维链推理      │
                    │ Reason 1: 询问主语实体  │
                    │ Knowledge 1: 检索知识   │
                    │ Reason 2: 识别实体类型  │
                    │ Reason 3: 确定答案      │
                    └──────────┬──────────────┘
                               │
                               ▼
                    ┌─────────────────────────┐
                    │     答案提取            │
                    │  基于Subject类型        │
                    │  返回三元组主语         │
                    └──────────┬──────────────┘
                               │
                               ▼
                    ┌─────────────────────────┐
                    │    返回最终答案         │
                    │     "Belgium"          │
                    └─────────────────────────┘
```

## 🧠 CoTKR 四种重写策略详解

```
                        ┌─────────────────────┐
                        │   检索到的三元组     │
                        │ (sub, rel, obj)     │
                        │ (sub_type, rel_type,│
                        │  obj_type)          │
                        └──────────┬──────────┘
                                   │
                                   ▼
                        ┌─────────────────────┐
                        │   问题类型判断       │
                        └─┬─────┬─────┬─────┬─┘
                          │     │     │     │
            ┌─────────────┘     │     │     └─────────────┐
            │                   │     │                   │
            ▼                   ▼     ▼                   ▼
    ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐
    │   Subject    │   │   Object     │   │  Relation    │   │    Type      │
    │    重写      │   │    重写      │   │    重写      │   │    重写      │
    └──────┬───────┘   └──────┬───────┘   └──────┬───────┘   └──────┬───────┘
           │                  │                  │                  │
           ▼                  ▼                  ▼                  ▼
    ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐
    │Reason 1:     │   │Reason 1:     │   │Reason 1:     │   │Reason 1:     │
    │询问执行动作   │   │询问接受动作   │   │询问实体间    │   │询问实体类型   │
    │的主语        │   │的宾语        │   │关系          │   │或类别        │
    └──────┬───────┘   └──────┬───────┘   └──────┬───────┘   └──────┬───────┘
           │                  │                  │                  │
           ▼                  ▼                  ▼                  ▼
    ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐
    │Knowledge 1:  │   │Knowledge 1:  │   │Knowledge 1:  │   │Knowledge 1:  │
    │三元组自然    │   │三元组自然    │   │三元组自然    │   │三元组自然    │
    │语言化        │   │语言化        │   │语言化        │   │语言化        │
    └──────┬───────┘   └──────┬───────┘   └──────┬───────┘   └──────┬───────┘
           │                  │                  │                  │
           ▼                  ▼                  ▼                  ▼
    ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐
    │Reason 2:     │   │Reason 2:     │   │Reason 2:     │   │Knowledge 2:  │
    │识别主语      │   │识别宾语      │   │考虑关系      │   │实体类型      │
    │实体类型      │   │实体类型      │   │类型          │   │映射          │
    └──────┬───────┘   └──────┬───────┘   └──────┬───────┘   └──────┬───────┘
           │                  │                  │                  │
           ▼                  ▼                  ▼                  ▼
    ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐
    │Knowledge 2:  │   │Knowledge 2:  │   │Knowledge 2:  │   │Reason 2:     │
    │主语类型      │   │宾语类型      │   │关系类型      │   │识别被询问    │
    │信息          │   │信息          │   │信息          │   │的实体类型    │
    └──────┬───────┘   └──────┬───────┘   └──────┬───────┘   └──────┬───────┘
           │                  │                  │                  │
           ▼                  ▼                  ▼                  ▼
    ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐
    │Reason 3:     │   │Reason 3:     │   │Reason 3:     │   │Reason 3:     │
    │基于模式      │   │基于模式      │   │识别具体      │   │确定请求的    │
    │识别主语      │   │识别宾语      │   │关系          │   │实体类型      │
    └──────┬───────┘   └──────┬───────┘   └──────┬───────┘   └──────┬───────┘
           │                  │                  │                  │
           └──────────────────┼──────────────────┼──────────────────┘
                              │                  │
                              └──────────────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │  生成思维链推理文本  │
                            │                     │
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │     答案提取        │
                            │                     │
                            │ Subject → 返回主语   │
                            │ Object  → 返回宾语   │
                            │ Relation→ 返回关系   │
                            │ Type    → 返回类型   │
                            └─────────────────────┘
```

## 🏗️ 系统架构层次图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           用户接口层                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │   simple_qa.py  │  │qa_system_demo.py│  │   interactive_qa        │  │
│  │   简单问答接口   │  │    演示系统     │  │   交互式问答            │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          核心引擎层                                      │
│  ┌─────────────────────────────────┐  ┌─────────────────────────────────┐│
│  │      retrieval_engine.py        │◄─┤      cotkr_rewriter.py         ││
│  │         检索引擎                │  │        CoTKR重写器              ││
│  │                                 │  │                                 ││
│  │ • retrieve_and_rewrite()        │  │ • rewrite_knowledge()           ││
│  │ • batch_retrieve()              │  │ • extract_answer_from_knowledge ││
│  │ • get_system_status()           │  │ • detect_question_type()        ││
│  └─────────────────────────────────┘  └─────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         数据管理层                                       │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────────────────┐ │
│ │vector_database  │ │embedding_client │ │      data_loader.py         │ │
│ │    .py          │ │     .py         │ │                             │ │
│ │                 │ │                 │ │ • load_xml_data()           │ │
│ │ • query_database│ │ • get_embedding │ │ • extract_triples()         │ │
│ │ • add_documents │ │ • batch_embed   │ │ • process_schemas()         │ │
│ │ • get_stats     │ │                 │ │                             │ │
│ └─────────────────┘ └─────────────────┘ └─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        外部服务层                                        │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────────────────┐ │
│ │ SiliconFlow API │ │    ChromaDB     │ │       XML Dataset           │ │
│ │                 │ │                 │ │                             │ │
│ │ • 嵌入服务       │ │ • 向量存储      │ │ • 知识图谱数据              │ │
│ │ • BAAI/bge-m3   │ │ • 相似度检索    │ │ • 三元组 + Schema           │ │
│ │ • 768维向量     │ │ • 持久化存储    │ │ • 训练/测试数据             │ │
│ └─────────────────┘ └─────────────────┘ └─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

## 📊 数据流向图

```
XML数据集 ──┐
           │
           ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │ 数据加载器   │───▶│ 嵌入客户端   │───▶│ 向量数据库   │
    │data_loader  │    │embedding_   │    │vector_      │
    │            │    │client       │    │database     │
    └─────────────┘    └─────────────┘    └─────────────┘
                                                 │
                                                 │
    用户问题 ──┐                                │
              │                                 │
              ▼                                 ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │ 问题向量化   │───▶│ 向量检索     │◄───│ 检索引擎     │
    │            │    │            │    │retrieval_   │
    │            │    │            │    │engine       │
    └─────────────┘    └─────────────┘    └─────────────┘
                                                 │
                                                 ▼
                                        ┌─────────────┐
                                        │ CoTKR重写器  │
                                        │cotkr_       │
                                        │rewriter     │
                                        └─────────────┘
                                                 │
                                                 ▼
                                        ┌─────────────┐
                                        │ 最终答案     │
                                        │            │
                                        └─────────────┘
```

## 🎯 问题类型处理示例

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        问题类型处理矩阵                                  │
├─────────────┬─────────────────┬─────────────────┬─────────────────────────┤
│  问题类型    │    问题特征      │    处理策略      │       返回结果           │
├─────────────┼─────────────────┼─────────────────┼─────────────────────────┤
│   Subject   │ Who...?         │ 识别主语实体     │ 三元组主语部分           │
│    (sub)    │ What wrote...?  │ 分析执行者       │ sub.replace('_', ' ')   │
├─────────────┼─────────────────┼─────────────────┼─────────────────────────┤
│   Object    │ Where...?       │ 识别宾语实体     │ 三元组宾语部分           │
│    (obj)    │ What did...?    │ 分析接受者       │ obj.replace('_', ' ')   │
├─────────────┼─────────────────┼─────────────────┼─────────────────────────┤
│  Relation   │ What relation...│ 识别关系类型     │ 三元组关系部分           │
│    (rel)    │ How connected...│ 分析连接方式     │ rel.replace('_', ' ')   │
├─────────────┼─────────────────┼─────────────────┼─────────────────────────┤
│    Type     │ What type...?   │ 识别实体类型     │ Schema类型信息           │
│   (type)    │ What kind...?   │ 分析类别归属     │ sub_type 或 obj_type    │
└─────────────┴─────────────────┴─────────────────┴─────────────────────────┘
```

## ⚡ 性能监控面板

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          系统性能监控                                    │
├─────────────────────────────────────────────────────────────────────────┤
│ 响应时间: ████████░░ 2.3s     │ 数据库状态: ████████████ 正常            │
│ 检索准确率: ██████████ 85%    │ 文档数量: 50 个                         │
│ 答案准确率: ████████░░ 78%    │ 向量维度: 768                           │
│ 并发用户: ███░░░░░░░ 3/10     │ 存储空间: ████░░░░░░ 45MB               │
├─────────────────────────────────────────────────────────────────────────┤
│ 最近查询:                                                               │
│ • "Who is the leader of Belgium?" → "Belgium" (2.1s)                   │
│ • "Where is Amsterdam Airport?" → "Netherlands" (1.8s)                 │
│ • "What type is Belgium?" → "Country" (2.5s)                           │
└─────────────────────────────────────────────────────────────────────────┘
```

这个ASCII流程图清晰地展示了KG-RAG问答系统的完整架构和处理流程，从用户输入到最终答案输出的每个步骤都有详细说明。