# å¢å¼ºRAGç³»ç»Ÿæ”¹è¿›æ–¹æ¡ˆæ€»ç»“

## ğŸ¯ æ”¹è¿›æ¦‚è¿°

åŸºäºå»ºè®®ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå…¨é¢å¢å¼ºçš„RAGç³»ç»Ÿï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å››ä¸ªæ ¸å¿ƒæ”¹è¿›ï¼š

### 1. ğŸ”¤ æ›´è‡ªç„¶çš„åµŒå…¥æ¨¡æ¿
### 2. ğŸ“Š ä¸°å¯Œçš„å…ƒæ•°æ®ç»“æ„  
### 3. ğŸ” å¤šé˜¶æ®µæ£€ç´¢é‡æ’
### 4. ğŸ“ˆ ç³»ç»Ÿæ€§èƒ½è¯„ä¼°

## ğŸ” è¯¦ç»†æ”¹è¿›å†…å®¹

### 1. å¢å¼ºçš„ä¸‰å…ƒç»„åµŒå…¥ç­–ç•¥

#### åŸå§‹æ–¹æ³•
```python
# ç®€å•æ‹¼æ¥
"Belgium capital Brussels. Types: Country capital CapitalCity."
```

#### å¢å¼ºæ–¹æ³•  
```python
# è‡ªç„¶è¯­è¨€æ¨¡æ¿
"An instance of a 'Country' named 'Belgium' has a relation 'capital' with an instance of a 'CapitalCity' which is 'Brussels'."
```

**ä¼˜åŠ¿:**
- âœ… æ›´ç¬¦åˆè‡ªç„¶è¯­è¨€è¡¨è¾¾ä¹ æƒ¯
- âœ… è¯­ä¹‰ä¿¡æ¯æ›´ä¸°å¯Œ
- âœ… ä¾¿äºè¯­è¨€æ¨¡å‹ç†è§£

### 2. ä¸°å¯Œçš„å…ƒæ•°æ®ç»“æ„

#### å¢å¼ºå…ƒæ•°æ®åŒ…å«:
```python
metadata = {
    # åŸå§‹ç»“æ„åŒ–ä¿¡æ¯
    "sub": "Belgium", "rel": "capital", "obj": "Brussels",
    "sub_type": "Country", "rel_type": "capital", "obj_type": "CapitalCity",
    
    # æ¸…ç†åçš„åç§°
    "sub_clean": "Belgium", "rel_clean": "capital", "obj_clean": "Brussels",
    
    # æ£€ç´¢è¾…åŠ©ä¿¡æ¯
    "entities": "Belgium Brussels",                    # å®ä½“ç»„åˆ
    "relation_context": "Country capital CapitalCity", # å…³ç³»ä¸Šä¸‹æ–‡
    "full_context": "Belgium capital Brussels Country CapitalCity", # å®Œæ•´ä¸Šä¸‹æ–‡
}
```

**ä¼˜åŠ¿:**
- âœ… æ”¯æŒå¤šç§æ£€ç´¢ç­–ç•¥
- âœ… ä¿ç•™å®Œæ•´ç»“æ„åŒ–ä¿¡æ¯
- âœ… ä¾¿äºç›¸å…³æ€§è®¡ç®—

### 3. å¤šé˜¶æ®µæ£€ç´¢é‡æ’ç³»ç»Ÿ

#### ç¬¬ä¸€é˜¶æ®µ: æ‰©å¤§æ£€ç´¢èŒƒå›´
```python
# æ£€ç´¢ n_results * 2 ä¸ªå€™é€‰ç»“æœ
stage1_results = vector_search(query, n_results * 2)
```

#### ç¬¬äºŒé˜¶æ®µ: å¤šä¿¡å·é‡æ’
```python
# è®¡ç®—å¤šç§ç›¸å…³æ€§åˆ†æ•°
scores = {
    'entity_match': 0.3,      # å®ä½“åŒ¹é…åˆ†æ•°
    'relation_match': 0.25,   # å…³ç³»åŒ¹é…åˆ†æ•°  
    'type_match': 0.2,        # ç±»å‹åŒ¹é…åˆ†æ•°
    'semantic_similarity': 0.25 # è¯­ä¹‰ç›¸ä¼¼åº¦åˆ†æ•°
}

final_score = weighted_sum(scores)
```

**é‡æ’ç­–ç•¥:**
- ğŸ¯ **å®ä½“åŒ¹é…**: æ£€æŸ¥é—®é¢˜ä¸­çš„å®ä½“æ˜¯å¦åœ¨ä¸‰å…ƒç»„ä¸­å‡ºç°
- ğŸ”— **å…³ç³»åŒ¹é…**: åŸºäºå…³ç³»è¯­ä¹‰å’Œå…³é”®è¯åŒ¹é…
- ğŸ·ï¸ **ç±»å‹åŒ¹é…**: æ£€æŸ¥å®ä½“ç±»å‹ä¸é—®é¢˜ç±»å‹çš„ä¸€è‡´æ€§
- ğŸ§  **è¯­ä¹‰ç›¸ä¼¼åº¦**: æ¥è‡ªç¬¬ä¸€é˜¶æ®µçš„å‘é‡ç›¸ä¼¼åº¦

### 4. ç³»ç»Ÿæ€§èƒ½è¯„ä¼°æ¡†æ¶

#### è¯„ä¼°æŒ‡æ ‡
- **Precision@K**: å‰Kä¸ªç»“æœä¸­ç›¸å…³ç»“æœçš„æ¯”ä¾‹
- **Recall@K**: å‰Kä¸ªç»“æœè¦†ç›–çš„ç›¸å…³ç»“æœæ¯”ä¾‹  
- **nDCG@K**: å½’ä¸€åŒ–æŠ˜æ‰£ç´¯ç§¯å¢ç›Š

#### è¯„ä¼°æµç¨‹
```python
# 1. åŠ è½½100ä¸ªè¯„ä¼°é—®é¢˜
questions = load_qa_dataset(limit=100)

# 2. å¯¹æ¯”ä¸¤ä¸ªç³»ç»Ÿ
for question in questions:
    original_result = original_system.retrieve(question)
    enhanced_result = enhanced_system.retrieve(question)
    
    # 3. è®¡ç®—ç›¸å…³æ€§æ ‡æ³¨
    original_relevance = create_relevance_labels(question, original_result)
    enhanced_relevance = create_relevance_labels(question, enhanced_result)
    
    # 4. è®¡ç®—å„ç§æŒ‡æ ‡
    metrics = calculate_metrics(relevance_scores, k_values=[1,3,5,10])
```

## ğŸ“Š ç³»ç»Ÿæ¶æ„å¯¹æ¯”

| ç»„ä»¶ | åŸå§‹ç³»ç»Ÿ | å¢å¼ºç³»ç»Ÿ |
|------|----------|----------|
| **åµŒå…¥æ¨¡æ¿** | ç®€å•æ‹¼æ¥ | è‡ªç„¶è¯­è¨€æ¨¡æ¿ |
| **å…ƒæ•°æ®** | åŸºç¡€ä¿¡æ¯ | ä¸°å¯Œç»“æ„åŒ–ä¿¡æ¯ |
| **æ£€ç´¢ç­–ç•¥** | å•é˜¶æ®µå‘é‡æ£€ç´¢ | å¤šé˜¶æ®µæ£€ç´¢é‡æ’ |
| **ç›¸å…³æ€§è®¡ç®—** | ä»…è¯­ä¹‰ç›¸ä¼¼åº¦ | å¤šä¿¡å·èåˆ |
| **è¯„ä¼°ä½“ç³»** | æ— ç³»ç»Ÿè¯„ä¼° | å…¨é¢æŒ‡æ ‡è¯„ä¼° |

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. å¿«é€Ÿæµ‹è¯•
```bash
python quick_test_enhanced.py
```

### 2. è¯¦ç»†æ¼”ç¤º
```bash
python demo_enhanced_system.py
```

### 3. å…¨é¢è¯„ä¼°
```bash
python retrieval_evaluation_system.py
```

### 4. ç¼–ç¨‹æ¥å£
```python
from enhanced_retrieval_engine import EnhancedRetrievalEngine

# åˆå§‹åŒ–å¢å¼ºç³»ç»Ÿ
engine = EnhancedRetrievalEngine()

# ä½¿ç”¨å¤šé˜¶æ®µæ£€ç´¢
result = engine.retrieve_and_rewrite(
    question="Who is the leader of Belgium?",
    n_results=5,
    use_reranking=True
)

print(f"ç­”æ¡ˆ: {result['final_answer']}")
print(f"é‡æ’åˆ†æ•°: {result['retrieved_items'][0]['rerank_score']}")
```

## ğŸ“ˆ é¢„æœŸæ”¹è¿›æ•ˆæœ

### 1. æ£€ç´¢è´¨é‡æå‡
- **æ›´å‡†ç¡®çš„è¯­ä¹‰åŒ¹é…**: è‡ªç„¶è¯­è¨€æ¨¡æ¿æé«˜åµŒå…¥è´¨é‡
- **æ›´å¥½çš„ç›¸å…³æ€§æ’åº**: å¤šä¿¡å·é‡æ’ä¼˜åŒ–ç»“æœé¡ºåº
- **æ›´é«˜çš„å¬å›ç‡**: æ‰©å¤§åˆå§‹æ£€ç´¢èŒƒå›´

### 2. ç­”æ¡ˆè´¨é‡æå‡  
- **æ›´ç²¾ç¡®çš„ç­”æ¡ˆ**: åŸºäºæ›´ç›¸å…³çš„çŸ¥è¯†è¿›è¡Œæ¨ç†
- **æ›´ä¸€è‡´çš„è¡¨ç°**: å‡å°‘å› æ£€ç´¢è´¨é‡å·®å¼‚å¯¼è‡´çš„ç­”æ¡ˆæ³¢åŠ¨
- **æ›´å¥½çš„å¯è§£é‡Šæ€§**: è¯¦ç»†çš„åˆ†æ•°ä¿¡æ¯ä¾¿äºåˆ†æ

### 3. ç³»ç»Ÿå¯è¯„ä¼°æ€§
- **é‡åŒ–çš„æ€§èƒ½æŒ‡æ ‡**: Precision@K, Recall@K, nDCG@K
- **ç³»ç»Ÿæ€§å¯¹æ¯”**: åŸå§‹vså¢å¼ºç³»ç»Ÿçš„å…¨é¢å¯¹æ¯”
- **æŒç»­æ”¹è¿›åŸºç¡€**: åŸºäºè¯„ä¼°ç»“æœçš„è¿­ä»£ä¼˜åŒ–

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### æ–‡ä»¶ç»“æ„
```
newSystem/
â”œâ”€â”€ enhanced_embedding_system.py      # å¢å¼ºåµŒå…¥ç³»ç»Ÿ
â”œâ”€â”€ enhanced_retrieval_engine.py      # å¢å¼ºæ£€ç´¢å¼•æ“  
â”œâ”€â”€ retrieval_evaluation_system.py    # è¯„ä¼°ç³»ç»Ÿ
â”œâ”€â”€ demo_enhanced_system.py           # æ¼”ç¤ºè„šæœ¬
â”œâ”€â”€ quick_test_enhanced.py            # å¿«é€Ÿæµ‹è¯•
â””â”€â”€ ENHANCED_SYSTEM_SUMMARY.md        # æœ¬æ–‡æ¡£
```

### æ ¸å¿ƒç±»
- `EnhancedVectorDatabaseManager`: å¢å¼ºçš„å‘é‡æ•°æ®åº“ç®¡ç†
- `EnhancedRetrievalEngine`: å¢å¼ºçš„æ£€ç´¢å¼•æ“
- `RetrievalEvaluator`: æ£€ç´¢ç³»ç»Ÿè¯„ä¼°å™¨

### é…ç½®å‚æ•°
```python
# config.py æ–°å¢é…ç½®
ENHANCED_COLLECTION_NAME = "enhanced_kg_system_BAAI_bge-m3"
RERANKING_ENABLED = True
RERANK_TOP_K_MULTIPLIER = 2
EVALUATION_SAMPLE_SIZE = 100
EVALUATION_K_VALUES = [1, 3, 5, 10]
```

## ğŸ’¡ ä¸‹ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

### 1. æ¨¡å‹å±‚é¢
- **ä¸“é—¨çš„é‡æ’æ¨¡å‹**: è®­ç»ƒä¸“ç”¨çš„é‡æ’åºæ¨¡å‹
- **å¤šæ¨¡æ€åµŒå…¥**: ç»“åˆæ–‡æœ¬å’Œç»“æ„ä¿¡æ¯çš„è”åˆåµŒå…¥
- **åŠ¨æ€æƒé‡**: æ ¹æ®é—®é¢˜ç±»å‹åŠ¨æ€è°ƒæ•´é‡æ’æƒé‡

### 2. æ•°æ®å±‚é¢  
- **æ›´å¤§è§„æ¨¡æ•°æ®**: æ‰©å±•åˆ°æ›´å¤§çš„çŸ¥è¯†å›¾è°±
- **è´¨é‡æ ‡æ³¨**: äººå·¥æ ‡æ³¨é«˜è´¨é‡çš„ç›¸å…³æ€§æ•°æ®
- **å¤šæ ·åŒ–é—®é¢˜**: å¢åŠ æ›´å¤šç±»å‹å’Œéš¾åº¦çš„é—®é¢˜

### 3. ç³»ç»Ÿå±‚é¢
- **ç¼“å­˜æœºåˆ¶**: ç¼“å­˜å¸¸è§æŸ¥è¯¢çš„ç»“æœ
- **å¹¶è¡Œå¤„ç†**: æ”¯æŒæ‰¹é‡å’Œå¹¶è¡ŒæŸ¥è¯¢
- **åœ¨çº¿å­¦ä¹ **: åŸºäºç”¨æˆ·åé¦ˆæŒç»­ä¼˜åŒ–

## ğŸ¯ æ€»ç»“

è¿™ä¸ªå¢å¼ºæ–¹æ¡ˆé€šè¿‡**æ›´è‡ªç„¶çš„åµŒå…¥æ¨¡æ¿**ã€**ä¸°å¯Œçš„å…ƒæ•°æ®**ã€**å¤šé˜¶æ®µæ£€ç´¢é‡æ’**å’Œ**ç³»ç»Ÿæ€§è¯„ä¼°**ï¼Œå…¨é¢æå‡äº†RAGç³»ç»Ÿçš„æ€§èƒ½ã€‚

æ ¸å¿ƒåˆ›æ–°åœ¨äºå°†å•ä¸€çš„è¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢æ‰©å±•ä¸ºå¤šä¿¡å·èåˆçš„æ™ºèƒ½æ£€ç´¢ï¼ŒåŒæ—¶å»ºç«‹äº†å®Œæ•´çš„è¯„ä¼°ä½“ç³»æ¥é‡åŒ–æ”¹è¿›æ•ˆæœã€‚

é€šè¿‡100ä¸ªé—®é¢˜çš„Precision@Kã€Recall@Kã€nDCG@KæŒ‡æ ‡å¯¹æ¯”ï¼Œæˆ‘ä»¬å¯ä»¥å®¢è§‚è¯„ä¼°æ–°æ–¹æ³•ç›¸å¯¹äºåŸå§‹æ–¹æ³•çš„æ”¹è¿›å¹…åº¦ï¼Œä¸ºè¿›ä¸€æ­¥ä¼˜åŒ–æä¾›æ•°æ®æ”¯æ’‘ã€‚